/*
                                        ....... ............
                                        ..,]]/@@@@@@@@@]]]..
                            . .....]/@@@@@@@@@@@@@@@@@@@@@@@@@@]........
                            ..\/@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\]...
                    ......,@@@@@@@@@@@@@@@@/[[.............*[\@@@@@@@@@@]`......
                    ...,@@@@@@@@@@@@@\@@..... ... ,\]..........@@@/\@@@@@@@@@]..
            ../@\`.....,[[[[\@@@....=@@@....    ..,@@@@@@@]`...@@@@@@\].,[@@@@@@@].........                                                                                 .. .......... ...
            ./@@@@@@\`......=@@@^..,@@@@^...    ...,@@@@@@@@@@@@\]......*`.....[\@@@@\`....                                                                                 ................
         ...=@@@@@@@@@@@@@@@@@@@@@@@@@@@@.....=@\]...\@@@@@@@@@@@@@@@@@\].............[[....                                                                                .................
        .. .@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@]...\@@@@^........,[[@@@@@@@@@@@@@]..............                                                                            .......,[\@@@@@]....
        ...=@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@`@@@@/.........=@@^.....*[[@@@@@@@`....,@\]......                                                                   ..*=O@@@@@@@@\]]].*......
        ...@@@@@@[[@@@@@@@@@@[\@@@@@@@@@@@@@@@@@@@@/]]].......=@@^....................=@@@@^....                                                                   ..*@@@@@O`\@^,^*@@@^......
        ..=@[...    ,@@@@@@`..=@@@....=@@@..\@@@@/..\@@@@@@@@]/@@\]]]]]]`...@@@].......,@@@@^...                                                                   .=*@@@@@*,@\.,..,@@^......
        ........    .=@@@@\...=@@@....=@@@...@@@@.....\@@@@@@@@@@@@@@@@@@@@`.\@@@@@^....@@@@^.......                                                               .,*@@@/*OOO.,*,[@@@^,.....
                    .=@@@@@...=@@@.. .=@@@...=@@@.......\@@@@@@@@/[[[@@@@@@@\.,@@@@@@...@@@@^...........                                                           .`=@@@@oO.*.*=@^`@@^*.....
                    .=@@@@@...=@@@....=@@@...@@@@..............@@^......,@@@@..,@@@@@@]@@@@@`.@@@\......                                                           .^=@@@`=@/*O..,,@@@*^.....
                    .=@@@@@^. =@@@ ...=@@@...@@@^..............@@^........,@/...=@@@@@@@@@@^..=@@@@`....                                                           .*=@@O/@O@@`/@@@@@@*^.....
                    .@@@@@@^ .=@@@ ...=@@@..=@@@...]]`........,@@*...............@@@@@@@@@/. ..@@@@@^...                                                           ..O@@@@@@@@\@@@@@@O*^.....
        ....    ..../@@@@@@^..=@@@... =@@@. /@@@...=@@@@@@@@@@@@@@@@@@]..........@@@@@@@@/.....,@@@@@...                                                           ..@@@@@@@@O@@@@@@@^=.....
        .\..    ...=@@@@@@@^..=@@@....=@@@..@@@^.....,@@@@@@@@@@@@@@@@@@@......./@@@@@@@`.....=@@@@@@^..                                                           .*@@@@@@@@**@O[O@@^O.....
        .@@.......=@@@@@@@@...@@@@..../@@@.=@@@`    ....[[[[@@@@@@@@@@@@@@`..../@@@@@@@@......@O@@@@@@.=@@@@@@]]]`..............                                ...*=@@@O@@@@**@@**@@*......
        =@@@\. ../@@@@@@@@\],@@@@..../@@@^.=@@@.    ..........@@@...........,@@@@@@@@@@^..../@@O@@@@@@.=@@@@@@@@@@@@@@@@@@]]]...                                ....=@@@*=@@^.,*`.*@@\*......
        .@@@@@@@@@@@@@@@@@@@@@@@@\]/@@@@^..=@@@             .,@@@..... .,O@@@@@[[\@@@@@^...@@@^.@@@@@^.=@@@@@@@@@@@@@@@@@@@@@@@@@@@\]`.............             .. .O@*....*]]O],]/@@,.......
        .\@@@@@@@@@@@@@@@@@@@@[[@@@@@@@@\]`@@@@.            .=@@@ ......,]]]....*@@@@@@@..=@@^.=@@@@@..@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\]......             .. .@@@@@@O@@@O@@@//.........
        .,@@@@@@@@@@@@@@@@@@`,@@@@@@/......\@@@O]]....  ,]]/@@@@@@@@@@@@[......=@@@@@@@@*.=@. .=@@@@^..     ............,[[@@@@@@@@@@@@@@@@@@@@@@]`... .          ...........................
        ..,@@@@@@@@@`......*.[*`[[`........=@@@.........=@@@@@@@@@@@@[.......,@@@@@@@@@@^......@@@@@....    .......... ...........,[[@@@@@@@@@@@@@@@@\`.          ...........................
    ........,[[[............................@@@@]]]@@@@@@@@@@@@@@@[.......,/@@@@@@@@@@@@@`... =@@@@@                .........,]@@@@@@@@@@@@@@@@@@@@@@@@@@@].....    ...,@@\]]]/@@@@@@@@@@]`.....
     ../@@@@@@@@@@@\O@@@@@@@@@@@@@\`......,]/@@@@@@@@/*@@@@@@@@/*]]]]@@@@@@@@@@@[`.@@@@@@^....@@@@@^                ...../@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\..    ...\@@@@@@@@@@@@@@@@@@@@@\`.
....,@@@@@@@@/[[[[\@@@\[@@@@@@@@@@@@@@@@@@@@@@@@@/[../@@@@@/`...............    ...@@@@@@@....@@@@@\                ..]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\`.... ...[@@@@@@@@@@@@@@@@@@@@@`...
...,@@@@@/......................,[@@@@@@@@@@/[......[[[*........... ........    ../@@@@@@@....@@@@@@                ,@@@@@@@@@@[`..=@@@@@@@@@@@@@@@@@@@.[@@@@@@@@@@@]...................,[@@@@@@@@`.
 ..@@@@@/ ..        ........... ...........  ...        ............    ........,@@@@@@@@^....\@@@@@....        .../@@@@@@@@/....,@@@@@@`.......[@@@@@@\...,\@@@@@@@@@@\.......             ,@@@@@@^....
..*@@@@@`...          .........     .......  ...                ....    ....../@@@@@@@@@@.....=@@@@@^...        .=@@@@@@@@/...../@@@@/............\@@@@@^.....,\@@@@@@@@@@\`....            .,@@@@@@. ..
...@@@@@@...        ............... .............................. ......]]@@@@@@@@@@@@@......=@@@@@@...........@@@@@@@@@`....,@@@@@`......     ..,@@@@@@. .    .,\@@@@@@@@@@@@`.............,@@@@@@^...
. .=@@@@@@`.        ......*............]]@@@@@@@@@@@]]]]]]]]]]]]]]@@@@@@@@@@@@@@@@@@@@/.. ..../@@@@@@\........,@@@@@@@@@...../@@@@@`.......     ..,@@@@@@^..    .....[@@@@@@@@@@@@@@]]]`]]]]@@@@@@@@...
    =@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*......./@@@@@@@@^....../@@@@@@@@^.....@@@@@@`....../@@@@@@@@@@@@@@@`..        ....,\@@@@@@@@@@@@@@@@@@@@@@@@@`
    ..\@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@/`.......,@@@@@@@@@@@^.../@@@@@@@@@`. ..,@@@@@@`..    =@@@@@@@@@@@@@@@@...        .........[\@@@@@@@@@@@@@@@@@@`..
        .[[[[[[[[[[[[[[[[[[[[[[[[[[@@@@/[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[....    ..@@@@@[\@@@[\@@..[[[[[[[[[[.....=@/[@@[`...... \@@@@@@@@@@@@@[`....                    ...,[[[[@@@[[[.....
        ..........................................  ................................    .............. ................................ ....................                    ...................
*/
#include <iostream>
#include <thread>
#include <opencv2/opencv.hpp>
#include <QFile>
#include <QDir>
#include <unistd.h>
#include <ctime>

#include "Settings/Settings.h"
#include "AngleSolver/PnpSolver.h"
#include "Camera/MVVideoCapture.h"
#include "Serial/PackData.h"
#include "Serial/Serial.h"
#include "ArmorDetector/ArmorDetector.h"
#include "RuneDetector/RuneDetector.h"
#include "Gui/Gui.h"

using namespace std;
using namespace cv;

void mainProcessing(MainSettings *main_setting, PackData *pack_data, UnpackData *unpack_data,
                    Serial *serial, ArmorSettings *armor_setting, RuneSettings *rune_setting);
#ifdef USE_CUTECOM
void openCuteCom();
#endif // USE_CUTECOM

int main()
{
#ifdef USE_CUTECOM
    //-----------------------------------【串口助手】------------------------------------------
    // brief：打开cutecom
    //---------------------------------------------------------------------------------------
    std::thread cutecom(&openCuteCom);
    sleep(2);

    system("xdotool getactivewindow windowsize 100% 100%"
           "&&xdotool mousemove 1200 45 click 1 key ctrl+a+Delete type /dev/ttyUSB0"
           "&&xdotool mousemove 150 45 click 1");
#endif // USE_CUTECOM

    //-----------------------------------【类初始化】------------------------------------------
    // brief：初始化类
    //---------------------------------------------------------------------------------------
    MainSettings main_setting(PARAM_OTHER_PATH);
    ArmorSettings armor_setting(PARAM_ARMOR_PATH);
    RuneSettings rune_setting(PARAM_RUNE_PATH);
    PackData pack_data;
    UnpackData unpack_data;
    UnpackData *p_unpack_data = &unpack_data;
    Serial serial(main_setting.port_param);

#ifdef USE_CUTECOM
    serial.openDevice();
#else // USE_CUTECOM
    serial.openPort("/dev/ttyUSB0");
#endif // USE_CUTECOM

    std::thread process_unpack(&UnpackData::processing, p_unpack_data, &serial);

    //-----------------------------------【主线程】--------------------------------------------
    // brief：装甲板识别、能量机关等
    //---------------------------------------------------------------------------------------
    std::thread process_main(&mainProcessing, &main_setting, &pack_data, &unpack_data, &serial, &armor_setting, &rune_setting);

    process_main.join();
    process_unpack.join();

    return 0;
}

#ifdef USE_CUTECOM
void openCuteCom()
{
    system("cutecom");
}
#endif // USE_CUTECOM

void mainProcessing(MainSettings *main_setting, PackData *pack_data, UnpackData *unpack_data,
                    Serial *serial, ArmorSettings *armor_setting, RuneSettings *rune_setting)
{
    //-----------------------------------【类初始化】--------------------------------------------
    // brief：初始化主函数类
    //-----------------------------------------------------------------------------------------
    ArmorDetector armor(armor_setting, main_setting, armor_setting->armor_contours);
    AngleSolver angle_slover(PARAM_CALIBRATION_752, 1, 10, 5000);
    RuneHitLogic rune(rune_setting, main_setting);
    GravityCompensateResolve gc = GravityCompensateResolve();

#ifdef DEBUG_MODE
    DataCollect dc(800, 720);
    std::vector<cv::Scalar> color_list = {cv::Scalar(0, 0, 255),  // 红 pitch角
                                          cv::Scalar(0, 255, 0)}; // 绿 yaw角
    std::vector<float> angle_data = {50, 1};
#endif // DEBUG_MODE

    long t1 = 0;

    //-----------------------------------【保存视频】--------------------------------------------
    // brief：从配置文件中获取当前序号，序号自增
    //------------------------------------------------------------------------------------------------
    cv::VideoWriter vw_src;
    if (main_setting->debug.b_save_result == true)
    {
        std::ostringstream s_src;

        int n = main_setting->debug.n_save_result;
        main_setting->debug.n_save_result++;
        main_setting->writeOtherParam(PARAM_OTHER_PATH);

        s_src << SAVE_VIDEO_DIR << "sentry_" << "src_" << n << ".avi";

        vw_src.open(s_src.str(),
                    cv::VideoWriter::fourcc('M', 'J', 'P', 'G'),
                    80,
                    cv::Size(SHOW_WIDTH / SHOW_RADIO, SHOW_HEIGHT / SHOW_RADIO),
                    true);
        if (vw_src.isOpened() == false)
        {
            std::cout << "Can't open *.avi file" << std::endl;
            return;
        }
    }

    //---------------------------------【工业相机/视频初始化】-------------------------------------
    // brief：初始化主函数类
    //-----------------------------------------------------------------------------------------
#if (USE_VIDEO == 0)
    std::cout << "MVVideoCapture Init" << std::endl;
    if(-1 == MVVideoCapture::Init())
    {
        std::cout << "MVVideoCapture ERROR!!!" << std::endl;
        return;
    }
    MVVideoCapture::Play();
    MVVideoCapture::SetExposureTime(false, main_setting->debug.expore_time);
    MVVideoCapture::SetLargeResolution(true);
    std::cout << "MVVideoCapture Finished!" << std::endl;
#elif (USE_VIDEO == 1)
    VideoCapture cap(VIDEO_PATH);
#endif  // USE_VIDEO

    //--------------------------------------【循环】--------------------------------------------
    // brief：
    //-----------------------------------------------------------------------------------------
    while(1)
    {
        // 设置参数滑动条
#ifdef DEBUG_MODE
        main_setting->setMainParam("主要设置");
#ifdef DEBUG_CAMERA
        main_setting->setCameraParam("camera");
        angle_slover.setRelationPoseCameraPTZ(main_setting->camera_param.x, main_setting->camera_param.y,
                                              main_setting->camera_param.z, main_setting->camera_param.y_offset);
#endif // DEBUG_CAMERA
        double t2 = (double)cv::getTickCount();
#endif // DEBUG_MODE

        t1 = cv::getTickCount();

        cv::Mat src;
#if (USE_VIDEO == 0)
        MVVideoCapture::GetFrame(src);
        if(src.empty())
        {
            std::cout << "Image empty!" << std::endl;
            continue;
        }
#elif (USE_VIDEO == 1)
        cap >> src;
        cv::resize(src, src, cv::Size(src.cols * 0.5, src.rows * 0.5));
#endif  // USE_VIDEO

#ifdef DEBUG_MODE
        if(main_setting->debug.b_save_pic)
            main_setting->grabImg(src, main_setting->debug.n_key_order, main_setting->debug.f_save_pic_inter * cv::getTickFrequency() / 1000.0);

        if(main_setting->debug.b_show_src)
        {
            cv::namedWindow("src");
            cv::imshow("src", src);
        }
        else
        {
            if(-1 != cv::getWindowProperty("src", 1))
                cv::destroyWindow("src");
        }
#endif  // DUBUG_MODE

        // 获取裁判系统敌方装甲板颜色
        if(unpack_data->getStm2PcMesg()->stm32_info_data.enemy_color == 1)
            main_setting->enemy_color = red;
        else if(unpack_data->getStm2PcMesg()->stm32_info_data.enemy_color == 2)
            main_setting->enemy_color = blue;

        static int flag, lost_flag;  // 标志，意味着进入自瞄模式第几次成功进入，切换其他模式flag归零

        //-----------------------------------【自瞄模式】--------------------------------------------
        // brief：
        // 1.识别灯条
        // 1.识别灯条
        // 2.获取所有甲板四个点位置
        // 3.选择最优的甲板（根据得分、滤波、插值或爬波函数）
        // 4.解算角度
        // 5.绘制检测信息与波形
        // 6.串口发送
        //-----------------------------------------------------------------------------------------
        if(main_setting->main_mode == armor_mode)
        {
#ifdef DEBUG_MODE
            armor_setting->setArmorParam(main_setting);
#endif // DEBUG_MODE
            armor.armorDetecProc(src, angle_slover, pack_data, unpack_data, serial, t1, gc, armor, flag, lost_flag);
            main_setting->main_mode_flag = 0;  // 确保模式更改的时候冲突参数的刷新
        }
        //-----------------------------------【小能量模式】------------------------------------------
        // brief：
        // 1.获取当前待激活装甲板位置
        // 2.预测出T时间后的装甲板位置
        // 3.解算角度
        // 4.串口发送
        //-----------------------------------------------------------------------------------------
        else if(main_setting->main_mode == small_rune_mode)
        {
            flag = 0;  // 自瞄识别成功次数标志归零
#ifdef DEBUG_MODE
            rune_setting->setRuneParam(main_setting);
#endif // DEBUG_MODE
            rune.smallRuneHitProc(src, angle_slover, pack_data, unpack_data, serial, t1, gc);
            main_setting->main_mode_flag = 1;  // 确保模式更改的时候冲突参数的刷新
        }
        //-----------------------------------【大能量模式】------------------------------------------
        // brief：
        // 1.获取当前待激活装甲板位置
        // 2.预测出T时间后的装甲板位置
        // 3.解算角度
        // 4.串口发送
        //-----------------------------------------------------------------------------------------
        else if(main_setting->main_mode == big_rune_mode)
        {
            flag = 0;  // 自瞄识别成功次数标志归零
#ifdef DEBUG_MODE
            rune_setting->setRuneParam(main_setting);
#endif // DEBUG_MODE
            rune.bigRuneHitProc(src, angle_slover, pack_data, unpack_data, serial, t1, gc);
            main_setting->main_mode_flag = 2;  // 确保模式更改的时候冲突参数的刷新
        }
        //-----------------------------------【静止能量模式】---------------------------------------
        // brief：
        // 1.获取当前待激活装甲板位置
        // 2.预测出T时间后的装甲板位置
        // 3.解算角度
        // 4.串口发送
        //-----------------------------------------------------------------------------------------
        else if(main_setting->main_mode == static_rune_mode)
        {
            flag = 0;  // 自瞄识别成功次数标志归零
#ifdef DEBUG_MODE
            rune_setting->setRuneParam(main_setting);
#endif // DEBUG_MODE
            rune.staticRuneHitProc(src, angle_slover, pack_data, unpack_data, serial, t1, gc);
            main_setting->main_mode_flag = 3;  // 确保模式更改的时候冲突参数的刷新
        }

#ifdef DEBUG_MODE
        if(main_setting->debug.b_show_dc)
        {
            angle_data.clear();
            angle_data = {armor.pit_final * 10, armor.yaw_final * 10};
            cv::namedWindow("pitch_and_yaw");
            dc.dataCollectProc(angle_data, color_list, "pitch_and_yaw");
        }
        else
        {
            if(-1 != cv::getWindowProperty("pitch_and_yaw", 1))
                cv::destroyWindow("pitch_and_yaw");
        }
#endif // DEBUG_MODE

#ifdef DEBUG_MODE
        main_setting->debug.n_key_order = cv::waitKey(1);
        if(tolower(main_setting->debug.n_key_order) == KEY_SAVE_PARAM)
        {
            main_setting->writeOtherParam(PARAM_OTHER_PATH);
            if(main_setting->main_mode == armor_mode)
                armor_setting->writeArmorParam(PARAM_ARMOR_PATH);
            else
                rune_setting->writeParamRune(PARAM_RUNE_PATH);
        }
        t2 = ((double)cv::getTickCount() - t2) / cv::getTickFrequency();
        armor.fps = 1.0 / t2;
//        if(main_setting->debug.b_show_fps)
//            std::cout << "FPS:       " << armor.fps << std::endl;
#if (USE_VIDEO == 1)
        cv::waitKey(33);
#endif // USE_VIDEO
#else // DEBUG_MODE
        cv::waitKey(1);
#endif // DEBUG_MODE
        if(main_setting->debug.b_save_result == true)
        {
            vw_src << src;
            if(main_setting->debug.n_key_order == KEY_SAVE_RESULT)
                vw_src.release();
        }
    }

    serial->closeDevice();

#if (USE_VIDEO == 0)
    MVVideoCapture::Stop();
    MVVideoCapture::Uninit();
#endif  // USE_VIDEO
}
